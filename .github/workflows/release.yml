name: Build and Release Package

on:
    push:
        tags:
            - "v*" # Triggers on v1.0.0, v1.0.1, etc.

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Get version from tag
              id: version
              run: |
                  echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
                  echo "PACKAGE_NAME=${GITHUB_REPOSITORY##*/}" >> $GITHUB_OUTPUT

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "22"

            - name: Checkout parent repository for workspace
              uses: actions/checkout@v3
              with:
                  repository: ${{ github.repository_owner }}/basecamp-dev
                  path: workspace-root
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup workspace and install dependencies
              run: |
                  # Copy this package into the workspace structure
                  mkdir -p workspace-root/npm_packages
                  cp -r . workspace-root/npm_packages/${{ steps.version.outputs.PACKAGE_NAME }}
                  
                  # Navigate to workspace root
                  cd workspace-root
                  
                  # Install all dependencies (respects workspace)
                  npm ci

            - name: Build package
              run: |
                  cd workspace-root/npm_packages/${{ steps.version.outputs.PACKAGE_NAME }}
                  npm run build

            - name: Prepare release package
              run: |
                  # Work from the built package directory
                  cd workspace-root/npm_packages/${{ steps.version.outputs.PACKAGE_NAME }}
                  
                  # Create a release directory
                  mkdir -p release-package
                  
                  # Copy necessary files
                  cp -r build release-package/
                  cp package.json release-package/
                  cp README.md release-package/ || true
                  
                  # Update package.json to point to built files
                  cd release-package
                  node -e "
                  const fs = require('fs');
                  const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
                  
                  // Update main to point to built file
                  if (pkg.main && pkg.main.includes('src/')) {
                    pkg.main = pkg.main.replace('src/', 'build/');
                  }
                  
                  // Ensure version matches tag
                  pkg.version = '${{ steps.version.outputs.VERSION }}';
                  
                  fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
                  "
                  
                  # Create tarball
                  cd ..
                  tar -czf ${{ steps.version.outputs.PACKAGE_NAME }}-${{ steps.version.outputs.VERSION }}.tar.gz -C release-package .

            - name: Publish to GitHub Packages
              run: |
                  cd release-package
                  
                  # Configure npm for GitHub Packages
                  echo "@builtnorth:registry=https://npm.pkg.github.com" >> .npmrc
                  echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc
                  
                  # Publish
                  npm publish
              env:
                  NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Create Release with GitHub CLI
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh release create "${{ github.ref_name }}" \
                    --title "Release ${{ github.ref_name }}" \
                    --notes "## ${{ steps.version.outputs.PACKAGE_NAME }} v${{ steps.version.outputs.VERSION }}

                      ### Installation

                      #### Via npm (from GitHub Packages):
                      \`\`\`bash
                      npm install @builtnorth/${{ steps.version.outputs.PACKAGE_NAME }}@${{ steps.version.outputs.VERSION }}
                      \`\`\`

                      #### Via package.json:
                      \`\`\`json
                      \"@builtnorth/${{ steps.version.outputs.PACKAGE_NAME }}\": \"${{ steps.version.outputs.VERSION }}\"
                      \`\`\`

                      ### What's included
                      - Compiled JavaScript (ES5)
                      - CSS styles (if applicable)
                      - Source maps for debugging

                      ### Changelog
                      See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)" \
                    ./${{ steps.version.outputs.PACKAGE_NAME }}-${{ steps.version.outputs.VERSION }}.tar.gz